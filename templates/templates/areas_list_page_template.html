<!DOCTYPE html>
<html>
  <head>
    <title>{% raw %}{{ _("Explore bouldering zones") }}{% endraw %} | MadBoulder</title>
	<meta name="description" content="Discover the best bouldering places in the world | MadBoulder">
	<link rel="canonical" href="https://www.madboulder.org/bouldering-areas-list">
  {% raw %}
	{% include 'scripts/tracking-tools-scripts.html' %}
	{% include 'elements/head-resources.html' %}
	<link rel="stylesheet" href="{{ url_for('static', filename='css/zones.css') }}" />
	{% include 'scripts/cookie-scripts.html' %}
	<script src="/static/js/jquery.translate.js" ></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.0/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="https://code.jquery.com/ui/1.14.0/jquery-ui.js"></script>
	<script src="/static/js/jquery.translate.js" ></script>
	<script src="/static/js/slider.js" ></script>
  <link href="/static/css/select2.min.css" rel="stylesheet" />
<script src="/static/js/select2.min.js"></script>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/zones.css') }}" />
  {% endraw %}
	
  </head>
  <body>
    <div id="current-language" hidden>{% raw %}{{ current_lang }}{% endraw %}</div>
	
    {% raw %}{% include 'elements/main-menu.html' %}{% endraw %}
	<main id="bouldering-areas-list">
		<div class="container" id="mainContainer">
      {% raw %}{% if session['is_admin'] %}{% endraw %}
        <a href="/add-area">
          Add New Area
        </a>
      {% raw %}{% endif %}{% endraw %}
			<div class="md-form active-pink active-pink-2 mt-2 mr-0" style="display:flex; flex-wrap: wrap; justify-content:center;">
				<input id="search-zone" class="form-control  mb-2" type="text" placeholder="Search" aria-label="Search" style="display: grid; align-self: center; border-color: black;">
				<button id="filter-button" class="filter-button btn mb-2" onclick="toggleFilters()">
				  <i class="fas fa-filter"></i><span id="filter-mark" class="filter-mark"></span>
				</button>
				<!-- Sort order -->
				<div class="btn-group mb-2 joint-btns">
					<div style="background: white; max-width: 100%; display: flex; border-radius: 0.25rem; border-color:black;">
						<select id="sort-criteria" onchange="ReorderZones()">
							<option value="alph" selected>{% raw %}{{ _("Alphabetically") }}{% endraw %}</option>
							<option value="nvid">{% raw %}{{ _("Number of videos") }}{% endraw %}</option>
							<option value="alt">{% raw %}{{ _("Altitude") }}{% endraw %}</option>
						</select>
						<button id="btn-asc" class="btn form-group-addon sort-btn" onclick="Sort(true)">
							<i class="fas fa-angle-up"></i>
						</button>
						<button id="btn-desc" class="btn form-group-addon sort-btn" onclick="Sort(false)">
							<i class="fas fa-angle-down"></i>
						</button>
					</div>
				</div>
			</div>
      <div id="filter-box" class="filter-box-container">
        <div class="filter-box">
          <div class="filter-section">
            <p class="filter-title">Filter by Number of Videos</p>
            <div id="video_slider" class="range_container" data-min="0" data-max="1000" data-values="[100, 800]" data-step="1" id="slider-container">
              <div id="slider-range"></div>
              <div class="range-label" id="min"></div>
              <div class="range-label" id="max"></div>
            </div>
          </div>
          <div class="filter-section">
            <div class="input-group flex-nowrap">
              <div class="input-group-prepend" style="display: flex;">
                <span class="input-group-text w-100">Country</span>
              </div>
              <select id="country-select" name="countries[]" multiple="multiple">
                {% for countryCode, countryData in country_data.items() %}
                  <option value="{{ countryCode }}" data-select2-id="country-{{ countryCode }}">{{ countryData['name'][0] }}</option>
                {% endfor %}
              </select>
            </div>       
          </div>
          <div class="filter-section">
              <p class="filter-title">Filter by Altitude</p>
              <div id="altitude_slider" class="range_container" data-min="50" data-max="1500" data-values="[0, 2000]" data-step="1" id="slider-container">
                <div id="slider-range"></div>
                <div class="range-label" id="min"></div>
                <div class="range-label" id="max"></div>
              </div>
          </div>
          <div class="filter-reset-section">
            <button class="filter-reset-button" onclick="resetFilters()">Reset Filters</button>
          </div>
          <script>
            function toggleFilters(){
              var filterBox = document.getElementById("filter-box");
              var filterButton = document.getElementById("filter-button");
              if (!filterBox.classList.contains("show-filters")) {
                filterBox.className += " show-filters";
                filterButton.className += " filters-visible";
                $('.range_container').refreshSlider();
              }
              else{
                filterBox.classList.remove("show-filters");
                filterButton.classList.remove("filters-visible");
              }
            }
  
            function onSliderChanged(){
              console.log("onSliderChanged");
              applyFilters();
            }
  
            function applyFilters(){
              var videoMin = parseInt($("#video_slider").find(".range-label#min").text());
              var videoMax = parseInt($("#video_slider").find(".range-label#max").text());
              var altitudeMin = parseInt($("#altitude_slider").find(".range-label#min").text());
              var altitudeMax = parseInt($("#altitude_slider").find(".range-label#max").text());
  
              var selectedCountryIds = $('#country-select').val() || [];
  
              $(".custom-card").each(function() {
                  var $card = $(this);
                  var videoCount = parseInt($card.find(".card-text").data("videos"));
                  var altitude = parseInt($card.find(".card-image-text").data("altitude"));
                  var country = $card[0].id.split("_")[1];
  
                  var matchesVideo = videoCount >= videoMin && videoCount <= videoMax;
                  var matchesAltitude = altitude >= altitudeMin && altitude <= altitudeMax;
                  var matchesCountry = selectedCountryIds.length === 0 || selectedCountryIds.includes(country);
  
                  if (matchesVideo && matchesAltitude && matchesCountry) {
                      $card.show();
                  } else {
                      $card.hide();
                  }
              });
  
              const filtersApplied = checkIfFiltersApplied();
              toggleFilterMark(filtersApplied);
            }
  
            function resetFilters() {
              var minVideos = $("#video_slider").data("min");
              var maxVideos = $("#video_slider").data("max");
              $("#video_slider").find("#slider-range").slider("values", [minVideos, maxVideos]);
              $("#video_slider").find(".range-label#min").text(minVideos);
              $("#video_slider").find(".range-label#max").text(maxVideos);
  
              $('#country-select').val(null).trigger('change');
  
              
              var minAltitude = $("#altitude_slider").data("min");
              var maxAltitude = $("#altitude_slider").data("max");
               $("#altitude_slider").find("#slider-range").slider("values", [minAltitude, maxAltitude]);
              $("#altitude_slider").find(".range-label#min").text(minAltitude);
              $("#altitude_slider").find(".range-label#max").text(maxAltitude);
  
              $(".custom-card").show();
  
              $("#search-zone").val("");
              toggleFilterMark(false);
            }
  
            function checkIfFiltersApplied() {
              const videoMin = parseInt($("#video_slider").find(".range-label#min").text());
              const videoMax = parseInt($("#video_slider").find(".range-label#max").text());
              const videoSliderMin = $("#video_slider").data("min");
              const videoSliderMax = $("#video_slider").data("max");
              const videoFilterApplied = (videoMin !== videoSliderMin || videoMax !== videoSliderMax);
  
              const altitudeMin = parseInt($("#altitude_slider").find(".range-label#min").text());
              const altitudeMax = parseInt($("#altitude_slider").find(".range-label#max").text());
              const altitudeSliderMin = $("#altitude_slider").data("min");
              const altitudeSliderMax = $("#altitude_slider").data("max");
              const altitudeFilterApplied = (altitudeMin !== altitudeSliderMin || altitudeMax !== altitudeSliderMax);
  
              const countryFilterApplied = $('#country-select').val().length > 0;
              
              const filtersApplied = videoFilterApplied || altitudeFilterApplied || countryFilterApplied;
              return filtersApplied;
            }
  
            function toggleFilterMark(show) {
                const filterMark = $("#filter-mark");
                if (show) {
                    filterMark.show();
                } else {
                    filterMark.hide();
                }
            }
          </script>
        </div>
      </div>

			<div id="zones-list" style="display: flex; flex-wrap: wrap; justify-content: center;">
				{% for zone_code, zone in zones.items() %}
					<div class="custom-card" id="{{ zone_code }}_{{zone['country']}}">
            {% set found_element = playlists.get(zone_code, None) %}
            {% if found_element %}
              <a href="/{{ zone_code }}" style="text-decoration: none;">
                <div class="card-body">
                  <div class="card-body-image-container">
                    <div class="card-body-image-container-container">
                      <p class="card-image-text"></p>
                      <img loading="lazy" class="card-body-image">
                    </div>
                  </div>
                  <div class="card-body-title-container">
                    <h5 class="text-bold card-title">{{ zone['name'] }}</h5>
                    <p class="card-text">
                    </p>
                  </div>
                </div>
              </a>
              <script>
                document.addEventListener("DOMContentLoaded", function() {
                    var card = document.getElementById("{{ zone_code }}_{{ zone['country'] }}");
                    var cardImage = card.querySelector(".card-body-image");
                    cardImage.src = "{{ found_element.thumbnails.maxres if found_element.thumbnails.maxres
                      else found_element.thumbnails.standard if found_element.thumbnails.standard
                      else found_element.thumbnails.high if found_element.thumbnails.high
                      else found_element.thumbnails.medium if found_element.thumbnails.medium
                                        else found_element.thumbnails.default}}";
                    var cardText = card.querySelector(".card-text");
                    var videoCount = {{ found_element.video_count }};
                    cardText.textContent = videoCount + " " + (videoCount === 1 ? "video" : "videos");
                    cardText.setAttribute("data-videos", videoCount);
                    
                    var cardImageText = card.querySelector(".card-image-text");
                    var altitude = {{ zone.altitude }};
                    cardImageText.textContent = altitude + " m";
                    cardImageText.setAttribute("data-altitude", altitude);
                });		
              </script>
            {% endif %}
					</div>
				{% endfor %}
			</div>
		</div>
	</main>
	{% raw %}{% include 'elements/footer.html' %}{% endraw %}
  </body>
  <script>
    var translator;
    var curr_lng = $("#current-language")[0].childNodes[0].nodeValue;
    var c_data = '{{ country_data | tojson | safe}}';
    var dict = JSON.parse(c_data);

    function removeElement(countryCode) {
        var $option = $('#country-select option[value="' + countryCode + '"]');
        if ($option.length && $option.prop('selected')) {
            $option.prop('selected', false);

            $("#selected-countries-list").find('li[data-country-code="' + countryCode + '"]').remove();

            applyFilters();
        }
    }
    
    function addElement(countryCode) {
      var $option = $('#country-select option[value="' + countryCode + '"]');
      if ($option.length && !$option.prop('selected')) {
          $option.prop('selected', true);

          // Add selected country to the rendered list
          var countryName = $option.text();
          $("#selected-countries-list").append(
              '<li class="select-selection--choice" data-country-code="' + countryCode + '">' +
              countryName + 
              '<span class="select-selection--choice-remove" onclick="removeElement(\'' + countryCode + '\')">Ã—</span></li>'
          );

          applyFilters();
          sessionStorage.setItem(countryCode, "active");
      }
  }
    
    function Sort(asc) {
      var criteria = $("#sort-criteria")[0].value;
      $(".custom-card").sort(function(a, b) {
        if (criteria==="nvid") {
          var aValue = parseInt($(a).find(".card-text").data("videos"));
          var bValue = parseInt($(b).find(".card-text").data("videos"));
          return (asc ? 1 : -1) * (aValue - bValue);
        }
        else if (criteria==="alph") {
          return (asc ? 1 : -1) * ($(a).find("h5")[0].textContent.localeCompare($(b).find("h5")[0].textContent));
        }
        else if (criteria === "alt") {  // Add this block for altitude sorting
            var aAltitude = parseInt($(a).find(".card-image-text").data("altitude"));
            var bAltitude = parseInt($(b).find(".card-image-text").data("altitude"));
            return (asc ? 1 : -1) * (aAltitude - bAltitude);
        }
      }).appendTo('#zones-list');
      sessionStorage.setItem("sortCriteria", criteria);
      if(asc){
        sessionStorage.setItem("sortOrder", "asc");
        $("#btn-asc").hide();
        $("#btn-desc").show();
      } 
      else{
        sessionStorage.setItem("sortOrder", "des");
        $("#btn-asc").show();
        $("#btn-desc").hide();
      }
    };
    
    function ReorderZones() {
      if (sessionStorage.getItem("sortOrder") === "asc")
          Sort(asc=true);
      else if (sessionStorage.getItem("sortOrder") === "des")
          Sort(asc=true);
    };
    
    function loadSessionStatus() {
      if (!sessionStorage.getItem("initialized")) {
        Sort(asc=true);
      } else {
        $("#sort-criteria")[0].value = sessionStorage.getItem("sortCriteria");
        ReorderZones();
      }
    };

    function loadSliders(){
      var $cards = $(".custom-card");

      var minVideos = Number.MAX_VALUE;
      var maxVideos = 1;
      $cards.each(function() {
        var videoCount = parseInt($(this).find(".card-text").data("videos"));
        if (videoCount < minVideos) minVideos = videoCount;
        if (videoCount > maxVideos) maxVideos = videoCount;
      });

      $("#video_slider").data("min", minVideos);
      $("#video_slider").data("max", maxVideos);
      $("#video_slider").data("values", [minVideos, maxVideos]);

      var minAltitudes = Number.MAX_VALUE;
      var maxAltitudes = 0;
      $cards.each(function() {
        var altitudeCount = parseInt($(this).find(".card-image-text").data("altitude"));
        if (altitudeCount < minAltitudes) minAltitudes = altitudeCount;
        if (altitudeCount > maxAltitudes) maxAltitudes = altitudeCount;
      });

      $("#altitude_slider").data("min", minAltitudes);
      $("#altitude_slider").data("max", maxAltitudes);
      $("#altitude_slider").data("values", [minAltitudes, maxAltitudes]);

      $('.range_container').initSlider();
    };
        
    window.addEventListener('load', function(){
      curr_lng = $("#current-language")[0].childNodes[0].nodeValue;
      translator = $('body').translate({lang: curr_lng, t: dict}); //use English
      translator.lang(curr_lng);
      loadSliders()
      loadSessionStatus();

      const filtersApplied = checkIfFiltersApplied();
      toggleFilterMark(filtersApplied);

      $('#country-select').select2({
          allowClear: true,
          width: '100%',
          closeOnSelect: true
      }).on('change', function() {
        applyFilters();
      });

      //Avoids Dropdown opening when deselecting option
      $('.select2-selection').on('click', '.select2-selection__choice__remove', function(evt) {
        evt.stopPropagation();
      })

      $("#search-zone").keyup(function() {
          var $cards = $(".custom-card");
          var val = $.trim(this.value).toLowerCase();
          if (val === "")
              $cards.show();
          else {
            $cards.hide();
            $cards.each(function(){
              if($(this).find(".card-title")[0].innerHTML.toLowerCase().indexOf(val) != -1){
                $(this).show();
              }
            });
          }
          // At this point we are only showing zones that matched the search pattern,
          // Now filter by country if required
          var $countries = $("#selected-countries")[0].childNodes;
          var ids = [];
          $countries.forEach(c => {
            if (c.id) ids.push(c.id);
          });
          if (ids.length === 0) {
            // No Ids, everything is already ok
            return;
          }
          // IDs ?
          $cards.each(
            function() {
              var country = $(this)[0].id.split("_")[1];
              if(!ids.includes(country)) {
                $(this).hide();
              }
            }
          );
      });
    });
  </script>  
</html>