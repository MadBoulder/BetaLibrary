<!DOCTYPE html>
<html>
  <head>
    <title>{% raw %}{{ _("Explore bouldering zones") }}{% endraw %} | MadBoulder</title>
	<meta name="description" content="Discover the best bouldering places in the world | MadBoulder">
	<link rel="canonical" href="https://www.madboulder.org/bouldering-areas-list">
  {% raw %}
	{% include 'scripts/tracking-tools-scripts.html' %}
	{% include 'elements/head-resources.html' %}
	<link rel="stylesheet" href="{{ url_for('static', filename='css/zones.css') }}" />
	{% include 'scripts/cookie-scripts.html' %}
	<script src="/static/js/jquery.translate.js" ></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.0/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="https://code.jquery.com/ui/1.14.0/jquery-ui.js"></script>
	<script src="/static/js/jquery.translate.js" ></script>
	<script src="/static/js/slider.js" ></script>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/zones.css') }}" />
  {% endraw %}
	
  </head>
  <body>
    <div id="current-language" hidden>{% raw %}{{ current_lang }}{% endraw %}</div>
    <!-- Country Selector Modal -->
    <div class="modal fade" id="country-modal" role="dialog">
      <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">{% raw %}{{ _("Filter zones") }}{% endraw %}</h4>
            <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <div class="row d-flex justify-content-center mt-100">
                <div class="col-md-6" id="inactive-countries-list"> 
                  {% for countryCode, countryData in country_data.items() %}
                  <div class="active-filter-selection row" id="{{ countryCode }}" data-country-name="{{ countryData['name'][0] }}"">
                    <span class="active-filter-text-list-item col-6 trn" style="display: grid; align-content:center;">
                      {{ countryData['name'][0] }}
                    </span>
                    <div class="col-6" style="display: flex; justify-content: flex-end;">
                      <button class="btn" onclick="addElement(this)">
                        <i class="fas fa-plus item-icon"></i>
                      </button>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- End Modal -->
	
    {% raw %}{% include 'elements/main-menu.html' %}{% endraw %}
	<main id="bouldering-areas-list">
		<div class="container" id="mainContainer">
      {% raw %}{% if session['is_admin'] %}{% endraw %}
        <a href="/add-area">
          Add New Area
        </a>
      {% raw %}{% endif %}{% endraw %}
			<div class="md-form active-pink active-pink-2 mt-2 mr-0" style="display:flex; flex-wrap: wrap; justify-content:center;">
				<input id="search-zone" class="form-control  mb-2" type="text" placeholder="Search" aria-label="Search" style="display: grid; align-self: center; border-color: black;">
				<button id="filter-button" class="filter-button btn mb-2" onclick="toggleFilters()">
				  <i class="fas fa-filter"></i><span id="filter-mark" class="filter-mark"></span>
				</button>
				<!-- Sort order -->
				<div class="btn-group mb-2 joint-btns">
					<div style="background: white; max-width: 100%; display: flex; border-radius: 0.25rem; border-color:black;">
						<select id="sort-criteria" onchange="ReorderZones()">
							<option value="alph" selected>{% raw %}{{ _("Alphabetically") }}{% endraw %}</option>
							<option value="nvid">{% raw %}{{ _("Number of videos") }}{% endraw %}</option>
							<option value="alt">{% raw %}{{ _("Altitude") }}{% endraw %}</option>
						</select>
						<button id="btn-asc" class="btn form-group-addon sort-btn" onclick="Sort(true)">
							<i class="fas fa-angle-up"></i>
						</button>
						<button id="btn-desc" class="btn form-group-addon sort-btn" onclick="Sort(false)">
							<i class="fas fa-angle-down"></i>
						</button>
					</div>
				</div>
			</div>

      <div id="filter-box" class="filter-box">
        <div class="filter-section">
          <p class="filter-title">Filter by Number of Videos</p>
          <div id="video_slider" class="range_container" data-min="0" data-max="1000" data-values="[100, 800]" data-step="1" id="slider-container">
            <div id="slider-range"></div>
            <div class="range-label" id="min"></div>
            <div class="range-label" id="max"></div>
          </div>
        </div>
        <div class="filter-section">
          <button class="btn mb-2" data-bs-toggle="modal" data-bs-target="#country-modal" style="background: white; border-color: black; margin-right: 0.5rem; margin-left: 0.5rem;">
          <span>{% raw %}{{ _("Add Country") }}{% endraw %}</span>
          </button>
          <div class="container" id="selected-countries" style="margin:inherit; padding: inherit; display: flex;">
        </div>
        <div class="filter-section">
            <p class="filter-title">Filter by Altitude</p>
            <div id="altitude_slider" class="range_container" data-min="50" data-max="1500" data-values="[0, 2000]" data-step="1" id="slider-container">
              <div id="slider-range"></div>
              <div class="range-label" id="min"></div>
              <div class="range-label" id="max"></div>
            </div>
          </div>
        </div>
        <div class="filter-reset-section">
          <button class="filter-reset-button" onclick="resetFilters()">Reset Filters</button>
        </div>
        <script>
          function toggleFilters(){
            var filterBox = document.getElementById("filter-box");
            var filterButton = document.getElementById("filter-button");
            if (!filterBox.classList.contains("show-filters")) {
              filterBox.className += " show-filters";
              filterButton.className += " filters-visible";
              $('.range_container').refreshSlider();
            }
            else{
              filterBox.classList.remove("show-filters");
              filterButton.classList.remove("filters-visible");
            }
          }

          function onSliderChanged(){
            console.log("onSliderChanged");
            applyFilters();
          }

          function applyFilters(){
            var videoMin = parseInt($("#video_slider").find(".range-label#min").text());
            var videoMax = parseInt($("#video_slider").find(".range-label#max").text());
            var altitudeMin = parseInt($("#altitude_slider").find(".range-label#min").text());
            var altitudeMax = parseInt($("#altitude_slider").find(".range-label#max").text());

            var $countries = $("#selected-countries")[0].childNodes;
            var selectedCountryIds = [];
            $countries.forEach(c => {
                if (c.id) selectedCountryIds.push(c.id);
            }); 

            $(".custom-card").each(function() {
                var $card = $(this);
                var videoCount = parseInt($card.find(".card-text").data("videos"));
                var altitude = parseInt($card.find(".card-image-text").data("altitude"));
                var country = $card[0].id.split("_")[1];

                var matchesVideo = videoCount >= videoMin && videoCount <= videoMax;
                var matchesAltitude = altitude >= altitudeMin && altitude <= altitudeMax;
                var matchesCountry = selectedCountryIds.length === 0 || selectedCountryIds.includes(country);

                if (matchesVideo && matchesAltitude && matchesCountry) {
                    $card.show();
                } else {
                    $card.hide();
                }
            });

            const filtersApplied = checkIfFiltersApplied();
            toggleFilterMark(filtersApplied);
          }

          function resetFilters() {
            var minVideos = $("#video_slider").data("min");
            var maxVideos = $("#video_slider").data("max");
            $("#video_slider").find("#slider-range").slider("values", [minVideos, maxVideos]);
            $("#video_slider").find(".range-label#min").text(minVideos);
            $("#video_slider").find(".range-label#max").text(maxVideos);

            var $selectedCountries = $("#selected-countries").children();
            $selectedCountries.each(function() {
                removeElement($(this).find(".btn")[0]);
            });

            
            var minAltitude = $("#altitude_slider").data("min");
            var maxAltitude = $("#altitude_slider").data("max");
             $("#altitude_slider").find("#slider-range").slider("values", [minAltitude, maxAltitude]);
            $("#altitude_slider").find(".range-label#min").text(minAltitude);
            $("#altitude_slider").find(".range-label#max").text(maxAltitude);

            $(".custom-card").show();

            $("#search-zone").val("");
            toggleFilterMark(false);
          }

          function checkIfFiltersApplied() {
            const videoMin = parseInt($("#video_slider").find(".range-label#min").text());
            const videoMax = parseInt($("#video_slider").find(".range-label#max").text());
            const videoSliderMin = $("#video_slider").data("min");
            const videoSliderMax = $("#video_slider").data("max");
            const videoFilterApplied = (videoMin !== videoSliderMin || videoMax !== videoSliderMax);

            const altitudeMin = parseInt($("#altitude_slider").find(".range-label#min").text());
            const altitudeMax = parseInt($("#altitude_slider").find(".range-label#max").text());
            const altitudeSliderMin = $("#altitude_slider").data("min");
            const altitudeSliderMax = $("#altitude_slider").data("max");
            const altitudeFilterApplied = (altitudeMin !== altitudeSliderMin || altitudeMax !== altitudeSliderMax);

            const selectedCountries = $("#selected-countries").children().length > 0;
            
            const filtersApplied = videoFilterApplied || altitudeFilterApplied || selectedCountries;
            return filtersApplied;
          }

          function toggleFilterMark(show) {
              const filterMark = $("#filter-mark");
              if (show) {
                  filterMark.show();
              } else {
                  filterMark.hide();
              }
          }
        </script>
      </div>

			<div id="zones-list" style="display: flex; flex-wrap: wrap; justify-content: center;">
				{% for zone_code, zone in zones.items() %}
					<div class="custom-card" id="{{ zone_code }}_{{zone['country']}}">
            {% set found_element = playlists.get(zone_code, None) %}
            {% if found_element %}
              <a href="/{{ zone_code }}" style="text-decoration: none;">
                <div class="card-body">
                  <div class="card-body-image-container">
                    <div class="card-body-image-container-container">
                      <p class="card-image-text"></p>
                      <img loading="lazy" class="card-body-image">
                    </div>
                  </div>
                  <div class="card-body-title-container">
                    <h5 class="text-bold card-title">{{ zone['name'] }}</h5>
                    <p class="card-text">
                    </p>
                  </div>
                </div>
              </a>
              <script>
                document.addEventListener("DOMContentLoaded", function() {
                    var card = document.getElementById("{{ zone_code }}_{{ zone['country'] }}");
                    var cardImage = card.querySelector(".card-body-image");
                    cardImage.src = "{{ found_element.thumbnails.maxres if found_element.thumbnails.maxres
                      else found_element.thumbnails.standard if found_element.thumbnails.standard
                      else found_element.thumbnails.high if found_element.thumbnails.high
                      else found_element.thumbnails.medium if found_element.thumbnails.medium
                                        else found_element.thumbnails.default}}";
                    var cardText = card.querySelector(".card-text");
                    var videoCount = {{ found_element.video_count }};
                    cardText.textContent = videoCount + " " + (videoCount === 1 ? "video" : "videos");
                    cardText.setAttribute("data-videos", videoCount);
                    
                    var cardImageText = card.querySelector(".card-image-text");
                    var altitude = {{ zone.altitude }};
                    cardImageText.textContent = altitude + " m";
                    cardImageText.setAttribute("data-altitude", altitude);
                });		
              </script>
            {% endif %}
					</div>
				{% endfor %}
			</div>
		</div>
	</main>
	{% raw %}{% include 'elements/footer.html' %}{% endraw %}
  </body>
  <script>
    var translator;
    var curr_lng = $("#current-language")[0].childNodes[0].nodeValue;
    var c_data = '{{ country_data | tojson | safe}}';
    var dict = JSON.parse(c_data);
    
    function sortCountryNodesAlphabetically() {
      var items = Array.prototype.slice.call($("#inactive-countries-list")[0].children);
      items.sort(function(a, b) {
         return $(a).find(".active-filter-text-list-item")[0].innerHTML.toLowerCase().localeCompare($(b).find(".active-filter-text-list-item")[0].innerHTML.toLowerCase());
      });
      for(var i = 0, len = items.length; i < len; i++) {
        var parent = items[i].parentNode;
        var detatchedItem = parent.removeChild(items[i]);
        parent.appendChild(detatchedItem);
      }
    }
    
    function removeElement(element) {
        var id_to_place = $(element).parent()[0].id;
        var text_to_place = $(element).parent().data('country-name');
        $("#inactive-countries-list").append(
          '<div class="active-filter-selection row" id="' + id_to_place + '">' +
            '<span class="active-filter-text-list-item col-6 trn" style="display: grid; align-content:center;">' +
              text_to_place +
            '</span>' +
            '<div class="col-6" style="display: flex; justify-content: flex-end;">' +
              '<button class="btn" onclick="addElement(this)">' +
                '<i class="fas fa-plus item-icon"></i>' +
              '</button>' +
            '</div>' +
          '</div>' 
        );
        translator.lang(curr_lng);
        $(element).parent().remove();
        sortCountryNodesAlphabetically();
        applyFilters();
        sessionStorage.setItem(id_to_place, "inactive");
        // Reset searchbox
        $("#search-zone")[0].value = "";
    };
    
    function addElement(element) {
        // Add to active selection list:
        var id_to_place = $(element).parent().parent()[0].id;
        var text_to_place = $(element).parent().parent().data('country-name');
        $("#selected-countries").append(
          '<div class="active-filter-selection" id="'+ id_to_place +'" data-country-name="'+ text_to_place +'" style="display: flex; padding: 0.2rem;"><span class="active-filter-text trn" style="align-self: center;">'+
          text_to_place +
          '</span><button class="btn" onclick="removeElement(this)"><i class="fas fa-times item-icon" style="display: grid;"></i></button></div>'
        );
        // Remove from list
        translator.lang(curr_lng);
        $(element).parent().parent().remove();
        sortCountryNodesAlphabetically();
        applyFilters();
        sessionStorage.setItem(id_to_place, "active");
        // close modal if open
        if (($("#country-modal").data('bs.modal') || {})._isShown)
          $('#country-modal').modal('toggle');
        // Reset searchbox
        $("#search-zone")[0].value = "";
    };
    
    function Sort(asc) {
      var criteria = $("#sort-criteria")[0].value;
      $(".custom-card").sort(function(a, b) {
        if (criteria==="nvid") {
          var aValue = parseInt($(a).find(".card-text").data("videos"));
          var bValue = parseInt($(b).find(".card-text").data("videos"));
          return (asc ? 1 : -1) * (aValue - bValue);
        }
        else if (criteria==="alph") {
          return (asc ? 1 : -1) * ($(a).find("h5")[0].textContent.localeCompare($(b).find("h5")[0].textContent));
        }
        else if (criteria === "alt") {  // Add this block for altitude sorting
            var aAltitude = parseInt($(a).find(".card-image-text").data("altitude"));
            var bAltitude = parseInt($(b).find(".card-image-text").data("altitude"));
            return (asc ? 1 : -1) * (aAltitude - bAltitude);
        }
      }).appendTo('#zones-list');
      sessionStorage.setItem("sortCriteria", criteria);
      if(asc){
        sessionStorage.setItem("sortOrder", "asc");
        $("#btn-asc").hide();
        $("#btn-desc").show();
      } 
      else{
        sessionStorage.setItem("sortOrder", "des");
        $("#btn-asc").show();
        $("#btn-desc").hide();
      }
    };
    
    function ReorderZones() {
      if (sessionStorage.getItem("sortOrder") === "asc")
          Sort(asc=true);
      else if (sessionStorage.getItem("sortOrder") === "des")
          Sort(asc=true);
    };
    
    function loadSessionStatus() {
      if (!sessionStorage.getItem("initialized")) {
        $("#inactive-countries-list")[0].childNodes.forEach(c => {
            if (c.tagName === 'DIV' && c.id) sessionStorage.setItem(c.id, "inactive");
          }
        );
        sessionStorage.setItem("initialized", "done");
        Sort(asc=true);
      } else {
        var to_be_modified = [];
        $("#inactive-countries-list")[0].childNodes.forEach(c => {
            if (c.tagName === 'DIV') {
              // if (sessionStorage.getItem(c.id) === "inactive") removeElement($(c).find(".btn")[0])
              if (sessionStorage.getItem(c.id) === "active" )
              {
                to_be_modified.push(c);
              }
            }
          }
        );
        to_be_modified.forEach(c => addElement($(c).find(".btn")[0]));
        $("#sort-criteria")[0].value = sessionStorage.getItem("sortCriteria");
        ReorderZones();
      }
    };

    function loadSliders(){
      var $cards = $(".custom-card");

      var minVideos = Number.MAX_VALUE;
      var maxVideos = 1;
      $cards.each(function() {
        var videoCount = parseInt($(this).find(".card-text").data("videos"));
        if (videoCount < minVideos) minVideos = videoCount;
        if (videoCount > maxVideos) maxVideos = videoCount;
      });

      $("#video_slider").data("min", minVideos);
      $("#video_slider").data("max", maxVideos);
      $("#video_slider").data("values", [minVideos, maxVideos]);

      var minAltitudes = Number.MAX_VALUE;
      var maxAltitudes = 0;
      $cards.each(function() {
        var altitudeCount = parseInt($(this).find(".card-image-text").data("altitude"));
        if (altitudeCount < minAltitudes) minAltitudes = altitudeCount;
        if (altitudeCount > maxAltitudes) maxAltitudes = altitudeCount;
      });

      $("#altitude_slider").data("min", minAltitudes);
      $("#altitude_slider").data("max", maxAltitudes);
      $("#altitude_slider").data("values", [minAltitudes, maxAltitudes]);

      $('.range_container').initSlider();
    };
        
    window.addEventListener('load', function(){
      curr_lng = $("#current-language")[0].childNodes[0].nodeValue;
      translator = $('body').translate({lang: curr_lng, t: dict}); //use English
      translator.lang(curr_lng);
      sortCountryNodesAlphabetically();
      loadSliders()
      loadSessionStatus();

      const filtersApplied = checkIfFiltersApplied();
      toggleFilterMark(filtersApplied);
    
      $("#search-zone").keyup(function() {
          var $cards = $(".custom-card");
          var val = $.trim(this.value).toLowerCase();
          if (val === "")
              $cards.show();
          else {
            $cards.hide();
            $cards.each(function(){
              if($(this).find(".card-title")[0].innerHTML.toLowerCase().indexOf(val) != -1){
                $(this).show();
              }
            });
          }
          // At this point we are only showing zones that matched the search pattern,
          // Now filter by country if required
          var $countries = $("#selected-countries")[0].childNodes;
          var ids = [];
          $countries.forEach(c => {
            if (c.id) ids.push(c.id);
          });
          if (ids.length === 0) {
            // No Ids, everything is already ok
            return;
          }
          // IDs ?
          $cards.each(
            function() {
              var country = $(this)[0].id.split("_")[1];
              if(!ids.includes(country)) {
                $(this).hide();
              }
            }
          );
      });
    });
  </script>  
</html>