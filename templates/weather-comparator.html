<!DOCTYPE html>
<html>
  <head>
	{% include 'scripts/tracking-tools-scripts.html' %}
    <title>Weather Comparator | MadBoulder</title>
	<meta name="description" content="Weather Comparator | MadBoulder">
	{% include 'elements/head-resources.html' %}
	{% include 'scripts/cookie-scripts.html' %}
	<script async src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js"></script>
	<script src="{{url_for('static', filename='js/openWeather.js')}}"></script>
	<script defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/weather-widget.css') }}" />
  </head>
  <body>
	{% include 'elements/main-menu.html' %}
	<main>
        <div class="container" id="mainContainer">
			<div id="weather-widget-container">
				<!-- Weather widgets will be loaded here -->
			</div>
			<div id="area-selection">
				<button id="zone-selector-btn"><i class="fas fa-plus"></i> Select a Zone</button>
			</div>
			<div id="zone-selector-popup" class="zone-selector-popup">
				<input type="text" id="search-box" placeholder="Search for a zone..." />
				<ul id="zone-list">
					{% for zone in zones %}
						<li data-value="{{ zone.latitude }},{{ zone.longitude }},{{ zone.name }},{{ zone.zone_code }}">{{ zone.name }}</li>
					{% endfor %}
				</ul>
			</div>
        </div>
		<script>
			async function createWeatherWidget(latitude, longitude, zoneName, zoneCode) {
				var uniqueId = 'weather-widget-' + zoneCode + '-' + Date.now();
				try {
					const response = await fetch('element/weather-widget.html');
					let template = await response.text();

					{% raw %}
					let widgetHtml = template.replace(/{{ uniqueId }}/g, uniqueId);
					widgetHtml = widgetHtml.replace(/{{ zone }}/g, zoneName);
					widgetHtml = widgetHtml.replace(/{{ zone_code }}/g, zoneCode);
					widgetHtml = widgetHtml.replace(/{{ lat }}/g, latitude);
					widgetHtml = widgetHtml.replace(/{{ lng }}/g, longitude);
					{% endraw %}

					$('#weather-widget-container').append(widgetHtml);
					var widget = document.getElementById(uniqueId)
					var removeButton = document.createElement("button");
					removeButton.setAttribute('class', 'remove-weather-widget-btn');
					removeButton.innerHTML = '<i class="fas fa-times"></i>'

					widget.appendChild(removeButton)

				} catch (error) {
					console.error('Failed to load weather widget template:', error);
				}
				updateURLWithVisibleWidgets()
			}
			
			function updateURLWithVisibleWidgets() {
				const zoneListItems = document.querySelectorAll('#zone-list > li');
				const visibleZoneCodes = Array.from(zoneListItems).filter(item => {
					const zoneCode = item.getAttribute('data-value').split(',')[3]; // Get zone code from data-value
					return document.querySelector(`[data-zone-code="${zoneCode}"]`);
				}).map(item => item.getAttribute('data-value').split(',')[3]); // Map to zone codes
				console.log(visibleZoneCodes);
				const newURL = `${location.pathname}?defaultZones=${visibleZoneCodes.join(',')}`;
				console.log(newURL);
				window.history.pushState({ path: newURL }, '', newURL);
			}

			document.addEventListener('DOMContentLoaded', function() {
				var defaultZones = {{ default_zones | tojson | safe }};
				const zoneListItems  = document.querySelectorAll('#zone-list > li');

				zoneListItems.forEach(item  => {
					const dataValue = item.getAttribute('data-value');
        			const [latitude, longitude, name, zoneCode] = dataValue.split(',');
					if (defaultZones.includes(zoneCode)) {
						createWeatherWidget(latitude, longitude, name, zoneCode);
					}
				});
			});

			$(document).ready(function() {
				function getDefaultZonesFromURL() {
					const urlParams = new URLSearchParams(window.location.search);
					const defaultZones = urlParams.get('defaultZones');
					return defaultZones ? defaultZones.split(',') : [];
				}

				$('#weather-widget-container').on('click', '.remove-weather-widget-btn', function() {
					$(this).closest('.weather-widget').remove();
					updateURLWithVisibleWidgets();
				});

				const popup = document.getElementById('zone-selector-popup');
				const btn = document.getElementById('zone-selector-btn');
    			const overlay = document.getElementById('overlay');
				
				btn.addEventListener('click', function() {
					const searchBox = document.getElementById('search-box');
					searchBox.value = '';
					const zoneList = document.getElementById('zone-list');
					const lis = zoneList.getElementsByTagName('li');
					for (let i = 0; i < lis.length; i++) {
						lis[i].style.display = "";
					}
					
					popup.style.display = 'block';
        			overlay.style.display = 'block';

					popup.scrollTop = 0;
				});

				popup.addEventListener('click', function(e) {
					if (e.target.tagName === 'LI') {
						const selectedValue = e.target.getAttribute('data-value');
						const [latitude, longitude, name, zoneCode] = selectedValue.split(',');
						createWeatherWidget(latitude, longitude, name, zoneCode);
						popup.style.display = 'none';
						overlay.style.display = 'none';
					}
				});
				
				overlay.addEventListener('click', function() {
					popup.style.display = 'none';
					this.style.display = 'none';
				});

				const searchBox = document.getElementById('search-box');
				searchBox.addEventListener('keyup', function() {
					const filter = this.value.toUpperCase();
					const zoneList = document.getElementById('zone-list').getElementsByTagName('li');
					for (let i = 0; i < zoneList.length; i++) {
						const li = zoneList[i];
						const txtValue = li.textContent || li.innerText;
						if (txtValue.toUpperCase().indexOf(filter) > -1) {
							li.style.display = "";
						} else {
							li.style.display = "none";
						}
					}
				});
			});
		</script>
	</main>
	{% include 'elements/footer.html' %}
	<div id="overlay" class="overlay"></div>
  </body>
</html>
